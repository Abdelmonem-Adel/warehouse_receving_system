<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø¨ÙˆØ§Ø¨Ø©</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap');
        body { font-family: 'Cairo', sans-serif; background-color: #f3f4f6; }
        .dock-card { transition: all 0.3s; }
        .status-available { border-color: #00A651; color: #00A651; background: #e6f7ed; }
        .status-busy { border-color: #ef4444; color: #ef4444; background: #fee2e2; }
    </style>
    <script src="js/auth.js"></script>
</head>
<body class="p-6">
    <header class="flex justify-between items-center mb-6 bg-white p-4 rounded shadow">
        <h1 class="text-2xl font-bold text-gray-800">ğŸš› Ø¨ÙˆØ§Ø¨Ø© Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø´Ø§Ø­Ù†Ø§Øª</h1>
        <a href="#" onclick="auth.logout()" class="text-red-500 hover:text-red-700 font-bold">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</a>
    </header>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <!-- Register Section -->
        <div class="md:col-span-1 bg-white p-6 rounded shadow h-fit">
            <h2 class="text-xl font-bold mb-4">ØªØ³Ø¬ÙŠÙ„ Ø´Ø§Ø­Ù†Ø© Ø¬Ø¯ÙŠØ¯Ø©</h2>
            <form id="registerForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©</label>
                    <input type="text" id="companyName" required class="w-full p-2 border rounded mt-1">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</label>
                    <input type="text" id="invoiceNumber" required class="w-full p-2 border rounded mt-1">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">ØªØ­Ø¯ÙŠØ¯ Ø±ØµÙŠÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                    <select id="dockSelect" class="w-full p-2 border rounded mt-1 bg-white">
                        <option value="">ØªÙ„Ù‚Ø§Ø¦ÙŠ (Ø£ÙŠ Ø±ØµÙŠÙ Ù…ØªØ§Ø­)</option>
                        <!-- Loaded dynamically -->
                    </select>
                </div>
                <button type="submit" class="w-full bg-[#00A651] text-white py-2 rounded font-bold hover:bg-[#008f45]">ØªØ³Ø¬ÙŠÙ„ ÙˆØ¯Ø®ÙˆÙ„</button>
            </form>
        </div>

        <!-- Docks & Queue Section -->
        <div class="md:col-span-2 space-y-6">
            <!-- Docks -->
            <div class="bg-white p-6 rounded shadow">
                <h2 class="text-xl font-bold mb-4">Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ø±ØµÙØ© (Docks)</h2>
                <div id="docksGrid" class="grid grid-cols-2 md:grid-cols-3 gap-4">
                    <!-- Loaded dynamically -->
                </div>
            </div>

            <!-- Queue -->
            <div class="bg-white p-6 rounded shadow">
                <h2 class="text-xl font-bold mb-4">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± (Queue)</h2>
                <div class="overflow-x-auto">
                    <table class="w-full text-right">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="p-2">#</th>
                                <th class="p-2">Ø§Ù„Ø´Ø±ÙƒØ©</th>
                                <th class="p-2">Ø±ØµÙŠÙ Ù…Ø­Ø¯Ø¯</th>
                                <th class="p-2">ÙˆÙ‚Øª Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</th>
                            </tr>
                        </thead>
                        <tbody id="queueList">
                            <!-- Loaded dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        window.onload = () => {
             auth.checkAuth(['gate']);
             fetchState();
        };

        async function fetchState() {
            // Fetch Docks
            const resDocks = await auth.fetchWithAuth('/api/docks');
            const docks = await resDocks.json();
            renderDocks(docks);
            updateDockSelect(docks);

            // Fetch Queue
            const resQueue = await auth.fetchWithAuth('/api/queue');
            const queue = await resQueue.json();
            renderQueue(queue);
        }

        function renderDocks(docks) {
            const container = document.getElementById('docksGrid');
            container.innerHTML = docks.map(dock => {
                const isAvailable = dock.status === 'available';
                // Only show Toggle if NO active shipment (Manual Control)
                const showToggle = !dock.currentShipment;

                return `
                <div class="dock-card border-2 rounded p-4 text-center ${isAvailable ? 'status-available' : 'status-busy'} relative group">
                    <h3 class="text-lg font-bold">Dock ${dock.number}</h3>
                    <p class="text-sm font-semibold">${isAvailable ? 'Ù…ØªØ§Ø­' : 'Ù…Ø´ØºÙˆÙ„'}</p>
                    ${dock.currentShipment ? `<p class="text-xs mt-2 text-gray-600 font-bold">${dock.currentShipment.companyName}</p>` : ''}
                    
                    ${showToggle ? `
                        <button onclick="toggleDock('${dock._id}', '${isAvailable ? 'busy' : 'available'}')" 
                            class="mt-2 text-xs border border-gray-400 px-2 py-1 rounded hover:bg-gray-100">
                            ${isAvailable ? 'â›” ØªØ¹ÙŠÙŠÙ† Ù…Ø´ØºÙˆÙ„' : 'âœ… ØªØ¹ÙŠÙŠÙ† Ù…ØªØ§Ø­'}
                        </button>
                    ` : ''}
                </div>
                `;
            }).join('');
        }

        function updateDockSelect(docks) {
            const select = document.getElementById('dockSelect');
            // Check if user has selected something, don't overwrite selected index unless changed
            const val = select.value;

            // Clear except default (option 0)
            while(select.options.length > 1) { select.remove(1); }

            docks.forEach(d => {
                const opt = document.createElement('option');
                opt.value = d._id;
                opt.text = `Dock ${d.number} (${d.status === 'available' ? 'Ù…ØªØ§Ø­' : 'Ù…Ø´ØºÙˆÙ„'})`;
                select.appendChild(opt);
            });

            if(val) select.value = val;
        }

        function renderQueue(queue) {
            const container = document.getElementById('queueList');
            if (queue.length === 0) {
                container.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-gray-500">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§Ù†ØªØ¸Ø§Ø±</td></tr>';
                return;
            }
            container.innerHTML = queue.map((q, idx) => `
                <tr class="border-b">
                    <td class="p-2">${idx + 1}</td>
                    <td class="p-2 font-bold">${q.companyName}</td>
                    <td class="p-2 text-sm">${q.dock ? 'Dock ' + q.dock.number : '-'}</td>
                    <td class="p-2 text-gray-500 text-sm">${new Date(q.createdAt).toLocaleTimeString()}</td>
                </tr>
            `).join('');
        }

        window.toggleDock = async (id, status) => {
            try {
                await auth.fetchWithAuth(`/api/docks/${id}/status`, {
                    method: 'POST',
                    body: JSON.stringify({ status })
                });
                fetchState();
            } catch (e) { console.error(e); }
        };

        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const companyName = document.getElementById('companyName').value;
            const invoiceNumber = document.getElementById('invoiceNumber').value;
            const dockId = document.getElementById('dockSelect').value || null;

            try {
                const res = await auth.fetchWithAuth('/api/companies', {
                    method: 'POST',
                    body: JSON.stringify({ companyName, invoiceNumber, dockId })
                });
                if (res && res.ok) {
                    document.getElementById('registerForm').reset();
                    fetchState();
                } else {
                    alert('Error adding company');
                }
            } catch (err) {
                console.error(err);
            }
        });

        // fetchState moved to onload
        setInterval(() => {
             if(auth.isLoggedIn()) fetchState();
        }, 5000);
    </script>
</body>
</html>
