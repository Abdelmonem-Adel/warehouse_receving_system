
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="./images/icons8-storekeeper-96.png">
    <title>Ù„ÙˆØ­Ø© Ø£Ù…ÙŠÙ† Ø§Ù„Ù…Ø®Ø²Ù†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap');
        body { font-family: 'Cairo', sans-serif; background-color: #f3f4f6; }
    </style>
    <script src="js/auth.js"></script>
</head>
<body class="p-6">
    <header class="flex justify-between items-center mb-8 bg-white p-4 rounded shadow">
        <div>
            <h1 class="text-2xl font-bold text-gray-800">ğŸ‘· Ø£Ù‡Ù„Ø§Ù‹ØŒ <span id="skNameSpan"></span></h1>
            <p class="text-sm text-gray-500">Ø­Ø§Ù„ØªÙƒ Ø§Ù„Ø­Ø§Ù„ÙŠØ©: <span id="statusSpan" class="font-bold">...</span></p>
        </div>
        <div>
            <button id="notifyBtn" class="bg-blue-100 text-blue-600 px-3 py-1 rounded text-sm mb-2 block hidden">ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</button>
            <a href="#" onclick="auth.logout()" class="text-red-500 text-sm">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</a>
        </div>
    </header>

    <div class="max-w-2xl mx-auto">
        <!-- Idle State (Available) -->
        <div id="idleState" class="hidden text-center py-10 bg-white rounded shadow-lg">
            <div class="text-6xl mb-4">â³</div>
            <h2 class="text-2xl font-bold text-gray-700">Ø£Ù†Øª Ø§Ù„Ø¢Ù† ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</h2>
            <p class="text-gray-500 mt-2">Ø³ÙŠØªÙ… Ø¥Ø´Ø¹Ø§Ø±Ùƒ ÙÙˆØ± ÙˆØµÙˆÙ„ Ø¯ÙˆØ±Ùƒ.</p>
            
            <button onclick="toggleBreak('break')" class="mt-8 bg-gray-200 text-gray-700 px-6 py-2 rounded-full font-bold hover:bg-gray-300 transition">
                â˜• Ø£Ø®Ø° Ø§Ø³ØªØ±Ø§Ø­Ø© (Break)
            </button>
        </div>

        <!-- Break State -->
        <div id="breakState" class="hidden text-center py-10 bg-orange-50 rounded shadow-lg border border-orange-200">
            <div class="text-6xl mb-4">â˜•</div>
            <h2 class="text-2xl font-bold text-orange-700">Ø£Ù†Øª ÙÙŠ Ø§Ø³ØªØ±Ø§Ø­Ø©</h2>
            <p class="text-gray-600 mt-2">Ù„Ù† ÙŠØªÙ… Ø¥Ø³Ù†Ø§Ø¯ Ø£ÙŠ Ù…Ù‡Ø§Ù… Ù„Ùƒ.</p>

            <button onclick="toggleBreak('available')" class="mt-8 bg-green-600 text-white px-6 py-2 rounded-full font-bold hover:bg-green-700 transition">
                â–¶ï¸ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø¹Ù…Ù„ (Available)
            </button>
        </div>

        <!-- Working State (Busy) -->
        <div id="workingState" class="hidden bg-white rounded shadow-lg overflow-hidden">
            <div class="bg-[#00A651] p-4 text-white text-center">
                <h2 class="text-2xl font-bold">ğŸ”” Ø¯ÙˆØ±Ùƒ Ù„Ù„Ø¹Ù…Ù„</h2>
            </div>
            <div class="p-6 text-center">
                <p class="text-gray-600 mb-2">ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙˆØ¬Ù‡ Ø¥Ù„Ù‰:</p>
                <div class="text-4xl font-bold text-gray-800 mb-6">Dock <span id="dockNumber">?</span></div>
                
                <div class="bg-gray-50 p-4 rounded mb-6 text-right">
                    <p class="text-sm text-gray-500 mb-1">Ø§Ù„Ø´Ø±ÙƒØ©:</p>
                    <p class="font-bold text-lg mb-3" id="companyName">...</p>
                    <p class="text-sm text-gray-500 mb-1">Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©:</p>
                    <p class="font-bold text-lg" id="invoiceNumber">...</p>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <!-- Injected via JS -->
                </div>
            </div>
        </div>

        <!-- Busy No Job State (Logic for Dock Only aftermath) -->
        <div id="busyIdleState" class="hidden text-center py-10 bg-white rounded shadow-lg">
             <div class="text-6xl mb-4">ğŸ–ï¸</div>
             <h2 class="text-2xl font-bold text-red-500">Ø£Ù†Øª ÙÙŠ Ø­Ø§Ù„Ø© Ù…Ø´ØºÙˆÙ„</h2>
             <p class="text-gray-500 mt-2">Ù„Ù‚Ø¯ Ù‚Ù…Øª Ø¨ØªØ­Ø±ÙŠØ± Ø§Ù„Ø¯ÙˆÙƒ ÙˆÙ„ÙƒÙ† Ù„Ù… ØªÙ†Ù‡ÙŠ Ø¹Ù…Ù„Ùƒ Ø¨Ø¹Ø¯.</p>
             <button onclick="resumeWork()" class="mt-6 bg-blue-600 text-white px-6 py-2 rounded font-bold hover:bg-blue-700">â–¶ï¸ Resume Work (busy)</button>
             <button onclick="toggleBreak('available')" class="mt-2 block mx-auto bg-green-100 text-green-700 px-4 py-1 rounded hover:bg-green-200">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø¹Ù…Ù„ (Available)</button>
        </div>
    </div>

    <script>
        window.onload = () => {
             auth.checkAuth(['storekeeper']);
             // Set skName from auth
             const user = auth.getUser();
             if(user) {
                 document.getElementById('skNameSpan').innerText = user.name;
             }
             fetchStatus();
        };

        const skId = auth.getUser()?.id;
        const skName = auth.getUser()?.name;
        const notifyBtn = document.getElementById('notifyBtn');

        // if (!skId) handled by checkAuth

        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding).replace(/\-/g, '+').replace(/_/g, '/');
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }

        async function fetchStatus() {
            try {
                const res = await auth.fetchWithAuth(`/api/storekeepers/${skId}/status`);
                if(!res) return;
                const data = await res.json();
                
                updateUI(data.storekeeper, data.currentJob);

                if (data.vapidKey && Notification.permission !== 'granted') {
                    notifyBtn.classList.remove('hidden');
                    notifyBtn.onclick = () => registerPush(data.vapidKey);
                } else if (data.vapidKey && Notification.permission === 'granted') {
                     registerPush(data.vapidKey);
                }
            } catch (err) {
                console.error(err);
            }
        }

        async function registerPush(vapidKey) {
            if ('serviceWorker' in navigator) {
                try {
                    const register = await navigator.serviceWorker.register('sw.js');
                    const subscription = await register.pushManager.subscribe({
                        userVisibleOnly: true,
                        applicationServerKey: urlBase64ToUint8Array(vapidKey)
                    });
                    
                    await auth.fetchWithAuth('/api/storekeepers/subscribe', {
                        method: 'POST',
                        body: JSON.stringify({ storekeeperId: skId, subscription })
                    });
                     

                    notifyBtn.classList.add('hidden');
                } catch (e) { }
            }
        }

        function updateUI(sk, job) {
            const statusSpan = document.getElementById('statusSpan');
            
            const idleDiv = document.getElementById('idleState');
            const breakDiv = document.getElementById('breakState');
            const workDiv = document.getElementById('workingState');
            const busyIdleDiv = document.getElementById('busyIdleState');

            // Hide all first
            idleDiv.classList.add('hidden');
            breakDiv.classList.add('hidden');
            workDiv.classList.add('hidden');
            busyIdleDiv.classList.add('hidden');

            // Text Status Update
            if (sk.status === 'available') {
                statusSpan.innerText = 'ğŸŸ¢ Ù…ØªØ§Ø­';
                statusSpan.className = 'font-bold text-[#00A651]';
                idleDiv.classList.remove('hidden');
            } 
            else if (sk.status === 'break') {
                statusSpan.innerText = 'â˜• Ø§Ø³ØªØ±Ø§Ø­Ø©';
                statusSpan.className = 'font-bold text-orange-600';
                breakDiv.classList.remove('hidden');
            }
            else { // Busy
                statusSpan.innerText = 'ğŸ”´ Ù…Ø´ØºÙˆÙ„';
                statusSpan.className = 'font-bold text-red-500';
                
                if (job) {
                    workDiv.classList.remove('hidden');
                    
                    // Handle Dock Display
                    const dockEl = document.getElementById('dockNumber');
                    if (job.dock) {
                        dockEl.innerText = job.dock.number;
                        dockEl.className = 'text-4xl font-bold text-gray-800 mb-6';
                    } else {
                        dockEl.innerText = 'ØªÙ… ØªØ­Ø±ÙŠØ± Ø§Ù„Ø¯ÙˆÙƒ';
                        dockEl.className = 'text-2xl font-bold text-orange-600 mb-6';
                    }

                    document.getElementById('companyName').innerText = job.companyName;
                    document.getElementById('invoiceNumber').innerText = job.invoiceNumber;

                    // Handle Buttons
                    const btnContainer = document.querySelector('#workingState .grid');
                    if (job.dock) {
                         btnContainer.innerHTML = `
                            <button onclick="finishJob('full')" class="bg-[#00A651] text-white py-3 rounded-lg font-bold hover:bg-[#008f45] transition shadow">
                                âœ… ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ <br><span class="text-xs font-normal opacity-80">(Ø§Ù„Ø¯ÙˆÙƒ ÙØ§Ø¶ÙŠ + Ø£Ù†Ø§ Ù…ØªØ§Ø­)</span>
                            </button>
                            <button onclick="finishJob('dock_only')" class="bg-yellow-500 text-white py-3 rounded-lg font-bold hover:bg-yellow-600 transition shadow">
                                 ğŸš§ Ø§Ù„Ø¯ÙˆÙƒ ÙØ§Ø¶ÙŠ ÙÙ‚Ø· <br><span class="text-xs font-normal opacity-80">(Ø§Ù„Ø¯ÙˆÙƒ ÙØ§Ø¶ÙŠ + Ø£Ù†Ø§ Ù…Ø´ØºÙˆÙ„)</span>
                            </button>
                        `;
                    } else {
                        // Dock already released
                         btnContainer.innerHTML = `
                            <button onclick="finishJob('full')" class="col-span-2 bg-[#00A651] text-white py-3 rounded-lg font-bold hover:bg-[#008f45] transition shadow">
                                âœ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ <br><span class="text-xs font-normal opacity-80">(Ø£Ù†Ø§ Ù…ØªØ§Ø­)</span>
                            </button>
                        `;
                    }

                } else {
                    busyIdleDiv.classList.remove('hidden');
                }
            }
        }

        window.finishJob = async (mode) => {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')) return;
            try {
                await auth.fetchWithAuth(`/api/storekeepers/${skId}/finish`, { 
                    method: 'POST',
                    body: JSON.stringify({ mode }) 
                });
                fetchStatus();
            } catch (err) {
                alert('Error');
            }
        };


        window.finishJob = async (mode) => {
  if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')) return;

  try {
    await auth.fetchWithAuth(`/api/storekeepers/${skId}/finish`, { 
      method: 'POST',
      body: JSON.stringify({ mode })
    });

    fetchStatus(); // Ù†Ø¬Ø§Ø­ ÙØ¹Ù„ÙŠ
  } catch (err) {
    alert(err.message || 'ÙØ´Ù„ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…');
  }
};


// window.toggleBreak = async (status) => {
//   try {
//     await auth.fetchWithAuth(`/api/storekeepers/${skId}/status`, {
//       method: 'POST',
//       body: JSON.stringify({ status })
//     });

//     fetchStatus(); // Ø·Ø§Ù„Ù…Ø§ Ù…Ø¬Ø§Ø´ Error ÙŠØ¨Ù‚Ù‰ ØªÙ…Ø§Ù…
//   } catch (e) {
//     alert(e.message || 'Error updating status');
//   }
// };


window.toggleBreak = async (status) => {
    // status is 'break' or 'available'
    try {
        const res = await auth.fetchWithAuth(`/api/storekeepers/${skId}/status`, {
            method: 'POST',
            body: JSON.stringify({ status })
        });
        if(res && res.ok) {
            fetchStatus();
        } else {
            const d = await res.json();
            alert(d.message || 'Error updating status');
        }
    } catch (e) {
        console.error(e);
        alert('Network Error');
    }
};

window.resumeWork = async () => {
    try {
        const res = await auth.fetchWithAuth(`/api/storekeepers/${skId}/resume`, { method: 'POST' });
        if(res && res.ok) {
            // Status updated to busy.
            fetchStatus();
        } else {
             const err = await res.json();
             alert('Error resuming: ' + (err.message || res.statusText));
        }
    } catch(e) { console.error(e); alert('Network Error'); }
};



        // window.toggleBreak = async (status) => {
        //     try {
        //         const res = await auth.fetchWithAuth(`/api/storekeepers/${skId}/status`, {
        //             method: 'POST',
        //             body: JSON.stringify({ status })
        //         });
        //         if(res && res.ok) fetchStatus();
        //         else alert('Error updating status');
        //     } catch (e) { console.error(e); }
        // };

        // fetchStatus moved to onload
        setInterval(() => {
             if(auth.isLoggedIn()) fetchStatus();
        }, 3000);
    </script>
</body>
</html>
